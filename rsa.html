<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple RSA Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: auto;
        }
        label, input, button {
            margin-top: 10px;
        }
        pre {
            background-color: #f8f8f8;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .value {
            display: inline-block;
            max-width: 400px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <h2>Easy to Understand RSA with Small Values!</h2>
    <p>Choose the number of bits (up to 8192) or specify p and q manually to see the generated RSA keys and encryption/decryption process.</p>

    <label for="bits">Bits (up to 8192):</label>
    <input type="number" id="bits" min="1" max="8192" value="8">
    <button onclick="generatePrimesAndCalculate()">Generate Primes</button>
    <br>
    <label for="p">Prime p:</label>
    <input type="text" id="p">
    <br>
    <label for="q">Prime q:</label>
    <input type="text" id="q">
    <br>
    <label for="e">Choose e:</label>
    <input type="radio" name="eOption" value="smallest" checked> Smallest value
    <input type="radio" name="eOption" value="0x10001"> 0x10001 (65537)
    <input type="radio" name="eOption" value="custom">
    <input type="number" id="customE" placeholder="Enter custom e">
    <br>
    <label for="message">Message to Encrypt:</label>
    <input type="number" id="message" value="42">
    <br>
    <button onclick="calculateRSA()">Calculate</button>

    <pre id="output"></pre>

    <script src="rsa.js"></script>
    <script>
        function calculateRSA() {
            const output = document.getElementById("output");
            output.innerHTML = "";

            let bits = parseInt(document.getElementById("bits").value);
            let pInput = document.getElementById("p").value;
            let qInput = document.getElementById("q").value;
            let messageInput = document.getElementById("message").value;

            try {
                let p = BigInt(pInput);
                let q = BigInt(qInput);
                let message = BigInt(messageInput);

                if (!isProbablyPrime(p)) {
                    alert("p must be a prime number.");
                    return;
                }
                if (!isProbablyPrime(q) || p === q) {
                    alert("q must be a prime number and different from p.");
                    return;
                }

                output.innerHTML += `<b>Step 1:</b> Choose two distinct prime numbers p and q.<br>`;
                output.innerHTML += `<span class="value">Prime p:</span> <span class="value">${p}</span><br>`;
                output.innerHTML += `<span class="value">Prime q:</span> <span class="value">${q}</span><br>`;

                const n = p * q;
                output.innerHTML += `<br><b>Step 2:</b> Compute n = p * q.<br>`;
                output.innerHTML += `<span class="value">n = p * q =</span> <span class="value">${p} * ${q} = ${n}</span><br>`;

                const lambda_n = lcm(p - 1n, q - 1n);
                output.innerHTML += `<br><b>Step 3:</b> Compute λ(n), which is the least common multiple (lcm) of (p-1) and (q-1).<br>`;
                output.innerHTML += `<span class="value">λ(n) = lcm(p-1, q-1) = ${lambda_n}</span><br>`;
                output.innerHTML += `<p>λ(n) is important because it represents the order of the multiplicative group of integers modulo n. It is used to determine the modular inverse in the decryption process, ensuring that messages encrypted with the public key can be decrypted correctly using the private key.</p>`;

                let e;
                const eOption = document.querySelector('input[name="eOption"]:checked').value;
                if (eOption === "smallest") {
                    const e_candidates = [2n, 3n, 5n, 7n, 11n, 13n, 17n, 19n, 23n];
                    for (let candidate of e_candidates) {
                        if (gcd(candidate, lambda_n) === 1n) {
                            e = candidate;
                            break;
                        }
                    }
                } else if (eOption === "0x10001") {
                    e = 0x10001n;
                } else if (eOption === "custom") {
                    e = BigInt(document.getElementById("customE").value);
                    if (gcd(e, lambda_n) !== 1n) {
                        alert("The custom e value must be coprime with λ(n). Please enter a different value.");
                        return;
                    }
                }

                output.innerHTML += `<br><b>Step 4:</b> Choose an integer e such that 1 < e < λ(n) and gcd(e, λ(n)) = 1. This value e is the public exponent.<br>`;
                output.innerHTML += `<span class="value">e = ${e}</span><br>`;

                const d = modInverse(e, lambda_n);
                output.innerHTML += `<br><b>Step 5:</b> Compute d, the modular multiplicative inverse of e modulo λ(n), so that (d * e) % λ(n) = 1. This value d is the private exponent.<br>`;
                output.innerHTML += `<span class="value">d = modInverse(e, λ(n)) = ${d}</span><br>`;

                output.innerHTML += `<br><b>Step 6:</b> The public key is composed of (e, n) and the private key is composed of (d, n).<br>`;
                output.innerHTML += `<span class="value">Public key: [e, n] = [${e}, ${n}]</span><br>`;
                output.innerHTML += `<span class="value">Private key: [d, n] = [${d}, ${n}]</span><br>`;

                const encrypted = modExp(message, e, n);
                output.innerHTML += `<br><b>Step 7:</b> Encrypt the message using the public key.<br>`;
                output.innerHTML += `The message <span class="value">${message}</span> is encrypted as follows:<br>`;
                output.innerHTML += `<span class="value">Encrypted = (message^e) % n = (${message}^${e}) % ${n} = ${encrypted}</span><br>`;

                const decrypted = modExp(encrypted, d, n);
                output.innerHTML += `<br><b>Step 8:</b> Decrypt the encrypted message using the private key.<br>`;
                output.innerHTML += `The encrypted message <span class="value">${encrypted}</span> is decrypted as follows:<br>`;
                output.innerHTML += `<span class="value">Decrypted = (Encrypted^d) % n = (${encrypted}^${d}) % ${n} = ${decrypted}</span><br>`;

                output.innerHTML += `<br><b>Step 9:</b> The original message is successfully recovered as <span class="value">${decrypted}</span>.<br>`;
            } catch (error) {
                alert("Invalid input. Please enter valid integers for p, q, and message.");
            }
        }
    </script>
</body>
</html>
